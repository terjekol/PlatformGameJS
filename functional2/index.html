<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript platform game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ramda/0.29.1/ramda.min.js"
        integrity="sha512-PVSAmDFNqey8GMII8s9rjjkCFvUgzfsfi8FCRxQa3TkPZfdjCIUM+6eAcHIFrLfW5CTFAwAYS4pzl7FFC/KE7Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="./js/pure.js"></script>
    <link rel="stylesheet" href="../styles.css" />
</head>

<body onload="init()">
    <!-- Game art by: https://bevouliin.com/ -->
    <canvas id="gameCanvas"></canvas>
    <img id="playerImg" src="../img/player.png" />
    <img id="enemyImg" src="../img/enemy.png" />
    <img id="backgroundImg" src="../img/background.png" />
    <script>
        function init() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const metadata = initMetadata();
            canvas.width = metadata.game.width;
            canvas.height = metadata.game.height;
            const keys = { right: false, left: false, up: false };
            const handleKey = keyboardEvent => {
                const key = keyboardEvent.key;
                if (!key.startsWith('Arrow')) return;
                const fieldName = key.substring(5).toLowerCase();
                keys[fieldName] = keyboardEvent.type.endsWith('down');
            };
            window.addEventListener('keydown', handleKey);
            window.addEventListener('keyup', handleKey);
            const images = ['background', 'player', 'enemy']
                .reduce((obj, name) => R.assoc(name, document.getElementById(name + 'Img'), obj), {});
            const initialState = initState(metadata);
            const gameLoop = state => {
                ctx.clearRect(0, 0, metadata.gameWidth, metadata.gameHeight);
                const params = { state, metadata, keys };
                const drawActions = getDrawActions(params);
                for (let drawAction of drawActions) {
                    const image = images[drawAction.image];
                    if (drawAction.hasOwnProperty('frameX')) {
                        ctx.drawImage(image, drawAction.frameX, drawAction.frameY,
                            drawAction.width, drawAction.height,
                            drawAction.x, drawAction.y,
                            drawAction.width, drawAction.height,
                        );
                    } else {
                        ctx.drawImage(image, drawAction.x, drawAction.y);
                    }
                }
                const returnValue = update(params);
                const newState = returnValue.state;
                requestAnimationFrame(() => gameLoop(newState));
            };
            gameLoop(initialState);

        }

        function initMetadata() {
            return {
                game: {
                    width: 800,
                    height: 720,
                },
                player: {
                    spriteSize: 200,
                    y: 720 - 200,
                    spriteCounts: [9, 7],
                },
                enemy: {
                    spriteWidth: 80,
                    spriteHeight: 60,
                    spriteCounts: [6],
                },
                background: {
                    width: 2400,
                }
            };
        }

        function initState(metadata) {
            return {
                background: { x: 0, speed: -2 },
                player: {
                    x: 0, speedX: 0,
                    y: metadata.player.y, speedY: 0,
                    spriteIndex: 0, spriteSkipIndex: 0, mode: 0,
                    downForce: 1,
                },
                enemy: { x: 0, y: metadata.enemy.y, speedX: -1, speedY: 0, spriteIndex: 0, spriteSkipIndex: 0 },
            };
        }
    </script>

</body>

</html>